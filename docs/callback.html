<!-- docs/callback.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>App Creation Complete</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded-lg shadow-md max-w-md w-full">
      <h1 class="text-2xl font-bold text-center mb-4">
        App Creation Complete!
      </h1>
      <div id="status" class="text-center">
        <div
          class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"
        ></div>
        <p>Processing your GitHub App...</p>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');

      async function exchangeCodeForApp(code) {
        try {
          // Step 3: Exchange the temporary code for app credentials
          const response = await fetch(
            `https://api.github.com/app-manifests/${code}/conversions`,
            {
              method: 'POST',
              headers: {
                Accept: 'application/vnd.github+json',
                'X-GitHub-Api-Version': '2022-11-28',
              },
            }
          );

          if (!response.ok) {
            throw new Error(
              `GitHub API error: ${response.status} ${response.statusText}`
            );
          }

          const appData = await response.json();
          console.log('GitHub App created successfully:', appData);

          return {
            id: appData.id,
            client_id: appData.client_id,
            client_secret: appData.client_secret,
            webhook_secret: appData.webhook_secret,
            pem: appData.pem, // Private key
            name: appData.name,
            html_url: appData.html_url,
          };
        } catch (error) {
          console.error('Error exchanging code:', error);
          throw error;
        }
      }

      if (code && state === localStorage.getItem('app-creation-state')) {
        const manifestName = localStorage.getItem('manifest-name');

        // Exchange code for app credentials
        exchangeCodeForApp(code)
          .then((appCredentials) => {
            console.log('App credentials received:', appCredentials);

            // Mark app as created
            const createdApps = JSON.parse(
              localStorage.getItem('created-apps') || '[]'
            );
            if (!createdApps.includes(manifestName)) {
              createdApps.push(manifestName);
              localStorage.setItem('created-apps', JSON.stringify(createdApps));
            }

            // Store app credentials (you might want to send these to your backend)
            localStorage.setItem(
              `app-credentials-${manifestName}`,
              JSON.stringify(appCredentials)
            );

            // Show success message
            document.getElementById('status').innerHTML = `
            <div class="text-green-600 mb-4">✅</div>
            <p class="text-green-600 font-medium">App "${manifestName}" created successfully!</p>
            <div class="mt-4 text-sm text-gray-600">
              <p><strong>App ID:</strong> ${appCredentials.id}</p>
              <p><strong>Client ID:</strong> ${appCredentials.client_id}</p>
              <p class="mt-2"><a href="${appCredentials.html_url}" target="_blank" class="text-blue-500 hover:underline">View on GitHub</a></p>
            </div>
            <button onclick="window.location.href='./'" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Back to Dashboard
            </button>
          `;
          })
          .catch((error) => {
            console.error('Failed to create app:', error);
            document.getElementById('status').innerHTML = `
            <div class="text-red-600 mb-4">❌</div>
            <p class="text-red-600 font-medium">Failed to create app: ${error.message}</p>
            <button onclick="window.location.href='./'" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Back to Dashboard
            </button>
          `;
          });
      } else {
        document.getElementById('status').innerHTML = `
        <div class="text-red-600 mb-4">❌</div>
        <p class="text-red-600 font-medium">Invalid callback state</p>
        <button onclick="window.location.href='./'" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
            Back to Dashboard
        </button>
      `;
      }
    </script>
  </body>
</html>
