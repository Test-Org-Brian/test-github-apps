<!-- docs/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Cloud Platform GitHub App Creator</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="./config.js"></script>
    <script src="./github_issue_ops.js"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-8">
      <h1 class="text-4xl font-bold text-center mb-8">GitHub App Creator</h1>

      <div
        id="app-tiles"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <!-- Tiles will be populated by JavaScript -->
      </div>
    </div>

    <script>
      let manifestsData = {};
      let issueOps;

      async function loadManifests() {
        try {
          const response = await fetch('./manifests.json');
          manifestsData = await response.json();

          if (
            !issueOps &&
            window.GitHubIssueOps &&
            window.APP_CONFIG &&
            window.APP_CONFIG.github
          ) {
            const config = window.APP_CONFIG.github;
            issueOps = new window.GitHubIssueOps({
              owner: config.org,
              repo: config.repo,
              token: config.token,
            });
          }
          const appStatus = await getAppStatus();

          const tilesContainer = document.getElementById('app-tiles');

          Object.keys(manifestsData).forEach((appName) => {
            const appManifest = manifestsData[appName];
            const status = appStatus[appName] || 'ready';
            const tile = createTile(appManifest, status);
            tilesContainer.appendChild(tile);
          });
        } catch (error) {
          console.error('Failed to load manifests:', error);
        }
      }

      function createTile(appManifest, status) {
        const tile = document.createElement('div');
        let borderClass = 'border-blue-500 hover:shadow-lg cursor-pointer';
        let statusLabel =
          '<span class="text-blue-600 text-sm font-medium">üöÄ Ready</span>';
        let buttonClass = 'bg-blue-500 text-white hover:bg-blue-600';
        let buttonText = 'Create App';
        let disabled = '';

        if (status === 'created') {
          borderClass = 'border-green-500 opacity-50 cursor-not-allowed';
          statusLabel =
            '<span class="text-green-600 text-sm font-medium">‚úÖ Created</span>';
          buttonClass = 'bg-gray-300 text-gray-500 cursor-not-allowed';
          buttonText = 'Already Created';
          disabled = 'disabled';
        } else if (status === 'in-progress') {
          borderClass = 'border-yellow-500 opacity-80 cursor-not-allowed';
          statusLabel =
            '<span class="text-yellow-600 text-sm font-medium">‚è≥ In Progress</span>';
          buttonClass = 'bg-yellow-300 text-yellow-700 cursor-not-allowed';
          buttonText = 'In Progress';
          disabled = 'disabled';
        }

        tile.className = `bg-white rounded-lg shadow-md p-6 border-l-4 ${borderClass}`;
        tile.innerHTML = `
          <div class="flex items-center justify-between">
            <h3 class="text-xl font-semibold text-gray-800">${
              appManifest.name
            }</h3>
            ${statusLabel}
          </div>
          <p class="text-gray-600 mt-2">${
            appManifest.description || 'GitHub App'
          }</p>
          <div class="mt-4 flex items-center justify-between">
            <div class="text-sm text-gray-500">
              Permissions: ${
                Object.keys(appManifest.default_permissions || {}).length
              } configured
            </div>
            <button
              onclick="createApp('${appManifest.name}')"
              class="px-4 py-2 rounded text-sm font-medium ${buttonClass}"
              ${disabled}
            >
              ${buttonText}
            </button>
          </div>
        `;
        return tile;
      }

      async function createApp(appName) {
        try {
          const appManifest = manifestsData[appName];
          if (!appManifest) {
            throw new Error(`Manifest not found for app: ${appName}`);
          }

          const config = window.APP_CONFIG.github;

          const state = generateState();
          const redirectUrl = `${window.location.origin}/${config.repo}/callback.html`;

          // Store state for callback
          localStorage.setItem('app-creation-state', state);
          localStorage.setItem('manifest-name', appManifest.name);

          // Add redirect URL to manifest
          appManifest.redirect_url = redirectUrl;

          // Create a form and submit it to GitHub
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `https://github.com/organizations/${config.org}/settings/apps/new?state=${state}`;

          // Add manifest as hidden input (state goes in URL, not form)
          const manifestInput = document.createElement('input');
          manifestInput.type = 'hidden';
          manifestInput.name = 'manifest';
          manifestInput.value = JSON.stringify(appManifest);
          form.appendChild(manifestInput);

          // Append form to body, submit, then remove
          document.body.appendChild(form);
          form.submit();
          document.body.removeChild(form);
        } catch (error) {
          console.error('Failed to create app:', error);
          alert('Failed to load manifest. Please try again.');
        }
      }

      function generateState() {
        return (
          Math.random().toString(36).substring(2, 15) +
          Math.random().toString(36).substring(2, 15)
        );
      }

      async function getAppStatus() {
        // Returns an object: { [appName]: 'created' | 'in-progress' }
        const status = {};
        if (issueOps) {
          try {
            // Get closed issues (created apps)
            const closedIssues = await issueOps.listIssues({
              state: 'closed',
              labels: ['github-app-automation'],
            });
            closedIssues.forEach((issue) => {
              status[issue.title] = 'created';
            });

            // Get open issues (in-progress apps)
            const openIssues = await issueOps.listIssues({
              state: 'open',
              labels: ['github-app-automation'],
            });
            openIssues.forEach((issue) => {
              // Only mark as in-progress if not already created
              if (!status[issue.title]) {
                status[issue.title] = 'in-progress';
              }
            });
          } catch (err) {
            console.error('Failed to fetch issues:', err);
          }
        }
        return status;
      }

      function markAppAsCreated(appName) {
        const createdApps = getCreatedApps();
        if (!createdApps.includes(appName)) {
          createdApps.push(appName);
          localStorage.setItem('created-apps', JSON.stringify(createdApps));
        }
      }

      // Load manifests when page loads
      document.addEventListener('DOMContentLoaded', loadManifests);
    </script>
  </body>
</html>
