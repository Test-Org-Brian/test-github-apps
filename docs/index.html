<!-- docs/index.html -->
<!DOCTYPE html>
<html>
  <head>
    <title>Cloud Platform GitHub App Creator</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script src="./config.js"></script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-8">
      <h1 class="text-4xl font-bold text-center mb-8">GitHub App Creator</h1>

      <div
        id="app-tiles"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <!-- Tiles will be populated by JavaScript -->
      </div>
    </div>

    <script>
      let manifestsData = {};

      async function loadManifests() {
        try {
          const response = await fetch('./manifests.json');
          manifestsData = await response.json();
          const createdApps = getCreatedApps();

          const tilesContainer = document.getElementById('app-tiles');

          Object.keys(manifestsData).forEach((appName) => {
            const appManifest = manifestsData[appName];
            const isCreated = createdApps.includes(appName);
            const tile = createTile(appManifest, isCreated);
            tilesContainer.appendChild(tile);
          });
        } catch (error) {
          console.error('Failed to load manifests:', error);
        }
      }

      function createTile(appManifest, isCreated) {
        const tile = document.createElement('div');
        tile.className = `bg-white rounded-lg shadow-md p-6 border-l-4 ${
          isCreated
            ? 'border-green-500 opacity-50 cursor-not-allowed'
            : 'border-blue-500 hover:shadow-lg cursor-pointer'
        }`;

        tile.innerHTML = `
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-semibold text-gray-800">${
                      appManifest.name
                    }</h3>
                    ${
                      isCreated
                        ? '<span class="text-green-600 text-sm font-medium">âœ… Created</span>'
                        : '<span class="text-blue-600 text-sm font-medium">ðŸš€ Ready</span>'
                    }
                </div>
                <p class="text-gray-600 mt-2">${
                  appManifest.description || 'GitHub App'
                }</p>
                <div class="mt-4 flex items-center justify-between">
                    <div class="text-sm text-gray-500">
                        Permissions: ${
                          Object.keys(appManifest.default_permissions || {})
                            .length
                        } configured
                    </div>
                    <button
                        onclick="createApp('${appManifest.name}')"
                        class="px-4 py-2 rounded text-sm font-medium ${
                          isCreated
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : 'bg-blue-500 text-white hover:bg-blue-600'
                        }"
                        ${isCreated ? 'disabled' : ''}
                    >
                        ${isCreated ? 'Already Created' : 'Create App'}
                    </button>
                </div>
            `;

        return tile;
      }

      async function createApp(appName) {
        try {
          const appManifest = manifestsData[appName];
          if (!appManifest) {
            throw new Error(`Manifest not found for app: ${appName}`);
          }

          const config = window.APP_CONFIG.github;

          const state = generateState();
          const redirectUrl = `${window.location.origin}/${config.repo}/callback.html`;

          // Store state for callback
          localStorage.setItem('app-creation-state', state);
          localStorage.setItem('manifest-name', appManifest.name);

          // Add redirect URL to manifest
          appManifest.redirect_url = redirectUrl;

          // Create a form and submit it to GitHub
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `https://github.com/organizations/${config.org}/settings/apps/new?state=${state}`;

          // Add manifest as hidden input (state goes in URL, not form)
          const manifestInput = document.createElement('input');
          manifestInput.type = 'hidden';
          manifestInput.name = 'manifest';
          manifestInput.value = JSON.stringify(appManifest);
          form.appendChild(manifestInput);

          // Store manifest for the callback
          localStorage.setItem('pending-manifest', JSON.stringify(appManifest));

          // Append form to body, submit, then remove
          document.body.appendChild(form);
          form.submit();
          document.body.removeChild(form);
        } catch (error) {
          console.error('Failed to create app:', error);
          alert('Failed to load manifest. Please try again.');
        }
      }

      function generateState() {
        return (
          Math.random().toString(36).substring(2, 15) +
          Math.random().toString(36).substring(2, 15)
        );
      }

      function getCreatedApps() {
        const created = localStorage.getItem('created-apps');
        return created ? JSON.parse(created) : [];
      }

      function markAppAsCreated(appName) {
        const createdApps = getCreatedApps();
        if (!createdApps.includes(appName)) {
          createdApps.push(appName);
          localStorage.setItem('created-apps', JSON.stringify(createdApps));
        }
      }

      // Load manifests when page loads
      document.addEventListener('DOMContentLoaded', loadManifests);
    </script>
  </body>
</html>
